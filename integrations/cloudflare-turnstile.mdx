---
title: 'Cloudflare Turnstile'
description: 'Strategy for implementing Cloudflare Turnstile to secure forms against bots and spam.'
icon: 'shield-check'
---

This guide details the strategy for implementing Cloudflare Turnstile (Smart CAPTCHA) to secure forms against bots and spam. It covers setup, frontend React integration, and backend verification using Netlify Functions (Node.js).

## Prerequisites

1.  **Cloudflare Account:** Log in to the [Cloudflare Dashboard](https://dash.cloudflare.com/).
2.  **Add Site:** Navigate to **Turnstile** in the sidebar and click **Add Site**.
    *   **Domain:** Enter your website's domain (e.g., `example.com`) and `localhost` for development.
    *   **Widget Mode:** Choose **Managed** (recommended) or **Invisible**.
3.  **Get Keys:**
    *   **Site Key:** Public key for the frontend widget.
    *   **Secret Key:** Private key for backend verification.

---

## 1. Environment Configuration

Define the keys in your environment variables.

**Frontend (`.env` or Netlify Build Settings):**
```bash
VITE_TURNSTILE_SITE_KEY="0x4AAAAAA..." # Replace with your actual Site Key
```

**Backend (Netlify Environment Variables):**
```bash
TURNSTILE_SECRET_KEY="0x4AAAAAA..." # Replace with your actual Secret Key
```

> **Note:** For local development, you can use the following test keys provided by Cloudflare:
> *   **Site Key (Always Pass):** `1x00000000000000000000AA`
> *   **Site Key (Always Block):** `2x00000000000000000000AB`
> *   **Secret Key (Always Pass):** `1x00000000000000000000000000000000AA`

---

## 2. Frontend Implementation (React)

### A. Load the Script

Add the Cloudflare script to your `index.html` `head` or `body`.

```html
<!-- index.html -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
```

### B. Create the Widget Component

Create a reusable wrapper component `src/components/TurnstileWidget.tsx`.

```tsx
import React, { useEffect, useRef } from 'react';

declare global {
  interface Window {
    turnstile: any;
  }
}

interface TurnstileWidgetProps {
  siteKey: string;
  onVerify: (token: string) => void;
  onError?: (error: any) => void;
}

const TurnstileWidget: React.FC<TurnstileWidgetProps> = ({ siteKey, onVerify, onError }) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const widgetIdRef = useRef<string | null>(null);

  useEffect(() => {
    if (window.turnstile && containerRef.current && !widgetIdRef.current) {
      try {
        const id = window.turnstile.render(containerRef.current, {
          sitekey: siteKey,
          callback: (token: string) => onVerify(token),
          'error-callback': (error: any) => onError?.(error),
        });
        widgetIdRef.current = id;
      } catch (e) {
        console.error('Failed to render Turnstile widget:', e);
      }
    }

    return () => {
      // Optional: cleanup logic if needed, though Turnstile handles this well.
      // Typically we reset on unmount or re-render if necessary.
      if (window.turnstile && widgetIdRef.current) {
         window.turnstile.remove(widgetIdRef.current);
         widgetIdRef.current = null;
      }
    };
  }, [siteKey, onVerify, onError]);

  return <div ref={containerRef} />;
};

export default TurnstileWidget;
```

### C. Integrate into Form

Use the widget in your form component (e.g., `QuoteForm.tsx`).

```tsx
import { useState } from 'react';
import TurnstileWidget from './TurnstileWidget';

export const QuoteForm = () => {
  const [turnstileToken, setTurnstileToken] = useState<string | null>(null);
  const [error, setError] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!turnstileToken) {
      setError('Please complete the security check.');
      return;
    }

    // Submit payload to backend
    const payload = {
      ...formData,
      'cf-turnstile-response': turnstileToken 
    };

    // ... API call logic ...
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* ... other fields ... */}
      
      <div className="my-4">
        <TurnstileWidget
          siteKey={import.meta.env.VITE_TURNSTILE_SITE_KEY}
          onVerify={(token) => {
            setTurnstileToken(token);
            setError('');
          }}
          onError={(err) => console.error('Turnstile Error:', err)}
        />
        {error && <p className="text-red-500 text-sm">{error}</p>}
      </div>

      <button type="submit">Submit</button>
    </form>
  );
};
```

---

## 3. Backend Verification (Netlify Functions / Node.js)

### A. Verification Utility

Create a utility function to handle the API verification logic (`netlify/functions/utils/verify.ts`).

```typescript
export async function verifyTurnstile(token: string, secret: string): Promise<boolean> {
  if (!token || !secret) {
    console.error('Turnstile verification failed: Missing token or secret.');
    return false;
  }

  try {
    const formData = new FormData();
    formData.append('secret', secret);
    formData.append('response', token);

    const response = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {
      method: 'POST',
      body: formData,
    });

    const data = await response.json();

    if (!response.ok) {
      console.error('Turnstile API error:', response.status);
      return false;
    }

    if (!data.success) {
      console.error('Turnstile validation failed:', data['error-codes']);
      return false;
    }

    return true;
  } catch (error) {
    console.error('Turnstile verification network error:', error);
    return false;
  }
}
```

### B. API Handler

Call the verification function in your endpoint handler (`netlify/functions/lead.ts`).

```typescript
import { verifyTurnstile } from './utils/verify';

export const handler = async (event) => {
  const data = JSON.parse(event.body);
  const token = data['cf-turnstile-response'];
  const secretKey = process.env.TURNSTILE_SECRET_KEY;

  // 1. Check if token exists
  if (!token) {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'Missing Turnstile token' }),
    };
  }

  // 2. Verify with Cloudflare
  const isValid = await verifyTurnstile(token, secretKey);

  if (!isValid) {
    return {
      statusCode: 403,
      body: JSON.stringify({ error: 'Invalid Turnstile token' }),
    };
  }

  // 3. Process the form submission...
  return {
    statusCode: 200,
    body: JSON.stringify({ message: 'Success' }),
  };
};
```

---

## Important Notes & Best Practices

1.  **Never Expose the Secret Key:** The `TURNSTILE_SECRET_KEY` must strictly remain on the server side. Never use it in frontend code.
2.  **Token Expiration:** Turnstile tokens expire after 300 seconds (5 minutes). If a user waits too long, they may need to refresh the widget. The `window.turnstile.reset()` method can handle this.
3.  **Localhost Testing:** Ensure `localhost` is added to your allowed domains in the Cloudflare Turnstile settings, or use the dummy testing keys provided in Section 1.
4.  **Graceful Degradation:** If the Cloudflare API is down (rare but possible), decide whether your app should fail open (allow submission) or fail closed (block submission). The current implementation fails closed (returns false on error).
5.  **Type Safety:** If using TypeScript, define the `Window` interface extension to include `turnstile` to avoid type errors.
